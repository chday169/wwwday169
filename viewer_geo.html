// ==================== åœ°è³ªæ•™æç€è¦½å™¨æ ¸å¿ƒä»£ç¢¼ ====================

// æ ¹æ“šç•¶å‰é é¢ç²å–æ­£ç¢ºçš„è·¯å¾‘é…ç½®
const pathConfig = PathResolver.getBasePath();
const manifestURL = pathConfig.manifest;

let pdfList = [];
let filteredList = [];
let currentIndex = -1;
let currentPage = 1;
let totalPages = 1;
let currentPDF = null;
let hasLikedCurrentPDF = false;
let currentScale = 1.5;

// åœ°è³ªæ•™æåˆ†é¡
const categories = {
  'all': 'å…¨éƒ¨æ•™æ',
  'structural': 'æ§‹é€ åœ°è³ª',
  'engineering': 'å·¥ç¨‹åœ°è³ª', 
  'fieldwork': 'é‡å¤–èª¿æŸ¥',
  'fundamental': 'åŸºç¤ç†è«–'
};

async function loadPDFList() {
  try {
    document.getElementById('statusText').innerHTML = '<span class="loading"></span>è¼‰å…¥åœ°è³ªæ•™ææ¸…å–®ä¸­...';
    
    console.log('æ­£åœ¨è¼‰å…¥ manifest:', manifestURL);
    
    // æ¸¬è©¦è·¯å¾‘
    const testResults = await PathResolver.testConnection(manifestURL, 'manifest.json');
    console.log(testResults.message);
    
    const res = await fetch(manifestURL);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('manifest.json æ‡‰ç‚ºé™£åˆ—æ ¼å¼');
    
    // ä¿®æ­£PDFè·¯å¾‘
    pdfList = data.map((item, index) => {
      const fixedUrl = PathResolver.fixPDFPath(item.url, pathConfig.pdfBase);
      console.log(`PDF ${index}: ${item.title} -> ${fixedUrl}`);
      
      return {
        ...item,
        url: fixedUrl,
        originalIndex: index
      };
    });
    
    console.log('è™•ç†å¾Œçš„PDFåˆ—è¡¨:', pdfList);
    
    // è¼‰å…¥æœ¬åœ°å„²å­˜çš„çµ±è¨ˆæ•¸æ“š
    loadLocalStats();

    // åˆå§‹åŒ–éæ¿¾åˆ—è¡¨
    filteredList = [...pdfList];
    updatePDFSelect();
    
    if (pdfList.length > 0) {
      showPDF(0);
    } else {
      document.getElementById('statusText').textContent = 'âŒ æ²’æœ‰å¯ç”¨çš„åœ°è³ªæ•™æ';
    }
  } catch (err) {
    console.error('è¼‰å…¥éŒ¯èª¤ï¼š', err);
    document.getElementById('statusText').innerHTML = 
      `âŒ ç„¡æ³•è¼‰å…¥åœ°è³ªæ•™ææ¸…å–®: ${err.message}<br>
      <small>è«‹æª¢æŸ¥: ${manifestURL} æ˜¯å¦å­˜åœ¨</small>`;
  }
}

function filterCategory(category) {
  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');

  if (category === 'all') {
    filteredList = [...pdfList];
  } else {
    filteredList = pdfList.filter(item => item.category === category);
  }

  updatePDFSelect();
  
  if (filteredList.length > 0) {
    showPDF(0);
  } else {
    document.getElementById('statusText').textContent = `âŒ æ²’æœ‰${categories[category]}ç›¸é—œæ•™æ`;
    clearCanvas();
  }
}

function updatePDFSelect() {
  const select = document.getElementById('pdfSelect');
  select.innerHTML = '';
  filteredList.forEach((item, index) => {
    const option = document.createElement('option');
    option.value = index;
    let displayText = `${index + 1}. ${item.title}`;
    if (item.category && categories[item.category]) {
      displayText += ` [${categories[item.category]}]`;
    }
    option.textContent = displayText;
    select.appendChild(option);
  });
}

function loadLocalStats() {
  const stats = JSON.parse(localStorage.getItem(pathConfig.statsKey) || '{}');
  pdfList.forEach((item, index) => {
    if (stats[item.title]) {
      item.views = stats[item.title].views || 0;
      item.likes = stats[item.title].likes || 0;
    } else {
      item.views = 0;
      item.likes = 0;
    }
  });
}

function saveLocalStats() {
  const stats = {};
  pdfList.forEach(item => {
    stats[item.title] = {
      views: item.views || 0,
      likes: item.likes || 0,
      lastViewed: new Date().toISOString()
    };
  });
  localStorage.setItem(pathConfig.statsKey, JSON.stringify(stats));
}

function showPDF(index) {
  if (index < 0 || index >= filteredList.length) return;
  currentIndex = index;
  currentPage = 1;
  hasLikedCurrentPDF = false;

  const selectedItem = filteredList[index];
  const originalIndex = pdfList.findIndex(item => item.title === selectedItem.title);
  const fileURL = selectedItem.url;
  
  console.log('å˜—è©¦è¼‰å…¥PDF:', fileURL);
  document.getElementById('statusText').innerHTML = '<span class="loading"></span>è¼‰å…¥åœ°è³ªæ•™æä¸­â€¦';

  // æ¸¬è©¦PDFè·¯å¾‘
  PathResolver.testConnection(fileURL, selectedItem.title).then(testResult => {
    console.log(testResult.message);
  });

  pdfjsLib.getDocument(fileURL).promise.then(pdf => {
    currentPDF = pdf;
    totalPages = pdf.numPages;
    renderPage(currentPage);
    
    // æ›´æ–°è¨ªå•æ¬¡æ•¸
    if (originalIndex >= 0) {
      pdfList[originalIndex].views = (pdfList[originalIndex].views || 0) + 1;
      saveLocalStats();
      updateStats(originalIndex);
    }
    
    document.getElementById('statusText').textContent =
      `ğŸª¨ ç•¶å‰æ•™æï¼š${selectedItem.title} (${index + 1}/${filteredList.length})`;
  }).catch(err => {
    console.error('PDF è¼‰å…¥å¤±æ•—ï¼š', err.message);
    document.getElementById('statusText').innerHTML = 
      `âŒ ç„¡æ³•é¡¯ç¤ºåœ°è³ªæ•™æï¼š${err.message}<br>
      <small>å˜—è©¦è·¯å¾‘: ${fileURL}</small>`;
    
    // æ¸…ç©ºç•«å¸ƒ
    clearCanvas();
  });

  document.getElementById('pdfSelect').value = index;
}

function renderPage(pageNum) {
  if (!currentPDF) return;
  
  currentPDF.getPage(pageNum).then(page => {
    const viewport = page.getViewport({ scale: currentScale });
    const canvas = document.getElementById('pdfCanvas');
    const context = canvas.getContext('2d');
    
    // è¨­ç½® canvas å°ºå¯¸
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const renderContext = {
      canvasContext: context,
      viewport: viewport
    };
    
    page.render(renderContext).promise.then(() => {
      document.getElementById('pageInfo').textContent = `ç¬¬ ${pageNum} é  / å…± ${totalPages} é `;
      document.getElementById('zoomLevel').textContent = Math.round(currentScale * 100) + '%';
    });
  }).catch(err => {
    console.error('é é¢æ¸²æŸ“å¤±æ•—ï¼š', err);
    document.getElementById('statusText').textContent = 'âŒ é é¢æ¸²æŸ“å¤±æ•—';
  });
}

function zoomIn() {
  currentScale += 0.25;
  if (currentPDF) renderPage(currentPage);
}

function zoomOut() {
  currentScale = Math.max(0.5, currentScale - 0.25);
  if (currentPDF) renderPage(currentPage);
}

function resetZoom() {
  currentScale = 1.5;
  if (currentPDF) renderPage(currentPage);
}

function clearCanvas() {
  const canvas = document.getElementById('pdfCanvas');
  const context = canvas.getContext('2d');
  context.clearRect(0, 0, canvas.width, canvas.height);
  canvas.width = 0;
  canvas.height = 0;
}

function prevPage() {
  if (currentPDF && currentPage > 1) {
    currentPage--;
    renderPage(currentPage);
  }
}

function nextPage() {
  if (currentPDF && currentPage < totalPages) {
    currentPage++;
    renderPage(currentPage);
  }
}

function prevPDF() {
  if (currentIndex > 0) {
    showPDF(currentIndex - 1);
  }
}

function nextPDF() {
  if (currentIndex < filteredList.length - 1) {
    showPDF(currentIndex + 1);
  }
}

function likePDF() {
  const selectedItem = filteredList[currentIndex];
  const originalIndex = pdfList.findIndex(item => item.title === selectedItem.title);
  if (originalIndex >= 0 && !hasLikedCurrentPDF) {
    pdfList[originalIndex].likes = (pdfList[originalIndex].likes || 0) + 1;
    hasLikedCurrentPDF = true;
    saveLocalStats();
    updateStats(originalIndex);
    
    // æ·»åŠ å‹•ç•«æ•ˆæœ
    const likeBtn = document.getElementById('likeBtn');
    likeBtn.classList.add('liked');
    likeBtn.textContent = 'â¤ï¸';
    
    setTimeout(() => {
      likeBtn.classList.remove('liked');
    }, 600);
  }
}

function updateStats(index) {
  const item = pdfList[index];
  document.getElementById('viewCount').textContent = item.views || 0;
  document.getElementById('likeCount').textContent = item.likes || 0;
}

function goBack() {
  window.location.href = 'index.html';
}

// äº‹ä»¶ç›£è½å™¨
document.getElementById('pdfSelect').addEventListener('change', function () {
  const index = parseInt(this.value);
  if (!isNaN(index)) showPDF(index);
});

// éµç›¤å¿«æ·éµæ”¯æŒ
document.addEventListener('keydown', function(event) {
  if (event.key === 'ArrowLeft') {
    prevPage();
  } else if (event.key === 'ArrowRight') {
    nextPage();
  } else if (event.key === 'ArrowUp') {
    prevPDF();
  } else if (event.key === 'ArrowDown') {
    nextPDF();
  } else if (event.key === '+') {
    zoomIn();
  } else if (event.key === '-') {
    zoomOut();
  }
});

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
  // åœ¨ head ä¸­æ·»åŠ  path-resolver
  if (typeof PathResolver === 'undefined') {
    const script = document.createElement('script');
    script.src = './js/path-resolver.js';
    script.onload = loadPDFList;
    document.head.appendChild(script);
  } else {
    loadPDFList();
  }
});