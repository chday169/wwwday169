// ==================== åœ°è´¨æ•™æä¸“ç”¨è·¯å¾„è§£æå™¨ ====================
const PathResolver = {
  getBasePath: function() {
    const baseUrl = window.location.origin + 
                    window.location.pathname.substring(0, 
                    window.location.pathname.lastIndexOf('/') + 1);
    return {
      manifest: baseUrl + 'data_geo/manifest.json',
      pdfBase: baseUrl + 'data_geo/pdfs/',
      statsKey: 'geo_stats'
    };
  },
  fixPDFPath: function(url, base) {
    if (url.startsWith('http://') || url.startsWith('https://')) {
      return url;
    }
    return base + url;
  }
};

// ==================== åœ°è³ªæ•™æç€è¦½å™¨æ ¸å¿ƒä»£ç¢¼ ====================
const pathConfig = PathResolver.getBasePath();
const manifestURL = pathConfig.manifest;

let pdfList = [], filteredList = [], currentIndex = -1;
let currentPage = 1, totalPages = 1, currentPDF = null;
let hasLikedCurrentPDF = false, currentScale = 1.5;

const categories = {
  'all': 'å…¨éƒ¨æ•™æ',
  'structural': 'æ§‹é€ åœ°è³ª',
  'engineering': 'å·¥ç¨‹åœ°è³ª', 
  'fieldwork': 'é‡å¤–èª¿æŸ¥',
  'fundamental': 'åŸºç¤ç†è«–'
};

async function loadPDFList() {
  try {
    document.getElementById('statusText').innerHTML = 
      '<span class="loading"></span>è¼‰å…¥åœ°è³ªæ•™ææ¸…å–®ä¸­...';
    console.log('æ­£åœ¨è¼‰å…¥ manifest:', manifestURL);
    
    const res = await fetch(manifestURL);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('manifest.json æ‡‰ç‚ºé™£åˆ—æ ¼å¼');
    
    pdfList = data.map((item, index) => {
      const fixedUrl = PathResolver.fixPDFPath(item.url, pathConfig.pdfBase);
      console.log(`PDF ${index}: ${item.title} -> ${fixedUrl}`);
      return { ...item, url: fixedUrl, originalIndex: index };
    });
    
    console.log('è™•ç†å¾Œçš„PDFåˆ—è¡¨:', pdfList);
    loadLocalStats();
    filteredList = [...pdfList];
    updatePDFSelect();
    
    if (pdfList.length > 0) showPDF(0);
    else document.getElementById('statusText').textContent = 'âŒ æ²’æœ‰å¯ç”¨çš„åœ°è³ªæ•™æ';
    
  } catch (err) {
    console.error('è¼‰å…¥éŒ¯èª¤ï¼š', err);
    document.getElementById('statusText').innerHTML = 
      `âŒ ç„¡æ³•è¼‰å…¥åœ°è³ªæ•™ææ¸…å–®: ${err.message}<br>
      <small>è«‹æª¢æŸ¥: ${manifestURL} æ˜¯å¦å­˜åœ¨</small>`;
  }
}

function filterCategory(category) {
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');

  if (category === 'all') filteredList = [...pdfList];
  else filteredList = pdfList.filter(item => item.category === category);

  updatePDFSelect();
  
  if (filteredList.length > 0) showPDF(0);
  else {
    document.getElementById('statusText').textContent = `âŒ æ²’æœ‰${categories[category]}ç›¸é—œæ•™æ`;
    clearCanvas();
  }
}

// å…¶ä½™å‡½æ•°ä¸Scratchæµè§ˆå™¨ç›¸åŒï¼Œåªéœ€ä¿®æ”¹æ˜¾ç¤ºæ–‡æœ¬å’ŒstatsKey
function updatePDFSelect() {
  const select = document.getElementById('pdfSelect');
  select.innerHTML = '';
  filteredList.forEach((item, index) => {
    const option = document.createElement('option');
    option.value = index;
    let displayText = `${index + 1}. ${item.title}`;
    if (item.category && categories[item.category]) {
      displayText += ` [${categories[item.category]}]`;
    }
    option.textContent = displayText;
    select.appendChild(option);
  });
}

function loadLocalStats() {
  const stats = JSON.parse(localStorage.getItem('geo_stats') || '{}');
  pdfList.forEach((item) => {
    if (stats[item.title]) {
      item.views = stats[item.title].views || 0;
      item.likes = stats[item.title].likes || 0;
    } else {
      item.views = 0;
      item.likes = 0;
    }
  });
}

function saveLocalStats() {
  const stats = {};
  pdfList.forEach(item => {
    stats[item.title] = {
      views: item.views || 0,
      likes: item.likes || 0,
      lastViewed: new Date().toISOString()
    };
  });
  localStorage.setItem('geo_stats', JSON.stringify(stats));
}

function showPDF(index) {
  if (index < 0 || index >= filteredList.length) return;
  currentIndex = index;
  currentPage = 1;
  hasLikedCurrentPDF = false;

  const selectedItem = filteredList[index];
  const fileURL = selectedItem.url;
  
  console.log('å˜—è©¦è¼‰å…¥PDF:', fileURL);
  document.getElementById('statusText').innerHTML = 
    '<span class="loading"></span>è¼‰å…¥åœ°è³ªæ•™æä¸­â€¦';

  pdfjsLib.getDocument(fileURL).promise.then(pdf => {
    currentPDF = pdf;
    totalPages = pdf.numPages;
    renderPage(currentPage);
    
    document.getElementById('statusText').textContent =
      `ğŸª¨ ç•¶å‰æ•™æï¼š${selectedItem.title} (${index + 1}/${filteredList.length})`;
  }).catch(err => {
    console.error('PDF è¼‰å…¥å¤±æ•—ï¼š', err.message);
    document.getElementById('statusText').innerHTML = 
      `âŒ ç„¡æ³•é¡¯ç¤ºåœ°è³ªæ•™æï¼š${err.message}<br>
      <small>å˜—è©¦è·¯å¾‘: ${fileURL}</small>`;
    clearCanvas();
  });

  document.getElementById('pdfSelect').value = index;
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', loadPDFList);