// ==================== ç„¦ç‚¹æ•™æä¸“ç”¨è·¯å¾„è§£æå™¨ ====================
const PathResolver = {
  getBasePath: function() {
    const baseUrl = window.location.origin + 
                    window.location.pathname.substring(0, 
                    window.location.pathname.lastIndexOf('/') + 1);
    return {
      manifest: baseUrl + 'data_foc/manifest.json',
      pdfBase: baseUrl + 'data_foc/pdfs/',
      statsKey: 'foc_stats'
    };
  },
  fixPDFPath: function(url, base) {
    if (url.startsWith('http://') || url.startsWith('https://')) {
      return url;
    }
    return base + url;
  }
};

// ==================== ç„¦é»æ•™æç€è¦½å™¨æ ¸å¿ƒä»£ç¢¼ ====================
const pathConfig = PathResolver.getBasePath();
const manifestURL = pathConfig.manifest;

let pdfList = [], currentIndex = -1;
let currentPage = 1, totalPages = 1, currentPDF = null;
let hasLikedCurrentPDF = false, currentScale = 1.5;

async function loadPDFList() {
  try {
    document.getElementById('statusText').innerHTML = 
      '<span class="loading"></span>è¼‰å…¥æ•™ææ¸…å–®ä¸­...';
    console.log('æ­£åœ¨è¼‰å…¥ manifest:', manifestURL);
    
    const res = await fetch(manifestURL);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('manifest.json æ‡‰ç‚ºé™£åˆ—æ ¼å¼');
    
    pdfList = data.map((item, index) => {
      const fixedUrl = PathResolver.fixPDFPath(item.url, pathConfig.pdfBase);
      console.log(`PDF ${index}: ${item.title} -> ${fixedUrl}`);
      return { ...item, url: fixedUrl, originalIndex: index };
    });
    
    console.log('è™•ç†å¾Œçš„PDFåˆ—è¡¨:', pdfList);
    loadLocalStats();

    const select = document.getElementById('pdfSelect');
    select.innerHTML = '';
    pdfList.forEach((item, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = `${index + 1}. ${item.title}`;
      select.appendChild(option);
    });

    if (pdfList.length > 0) showPDF(0);
    else document.getElementById('statusText').textContent = 'âŒ æ²’æœ‰å¯ç”¨çš„æ•™æ';
    
  } catch (err) {
    console.error('è¼‰å…¥éŒ¯èª¤ï¼š', err);
    document.getElementById('statusText').innerHTML = 
      `âŒ ç„¡æ³•è¼‰å…¥æ•™ææ¸…å–®: ${err.message}<br>
      <small>è«‹æª¢æŸ¥: ${manifestURL} æ˜¯å¦å­˜åœ¨</small>`;
  }
}

function loadLocalStats() {
  const stats = JSON.parse(localStorage.getItem('foc_stats') || '{}');
  pdfList.forEach((item) => {
    if (stats[item.title]) {
      item.views = stats[item.title].views || 0;
      item.likes = stats[item.title].likes || 0;
    } else {
      item.views = 0;
      item.likes = 0;
    }
  });
}

function saveLocalStats() {
  const stats = {};
  pdfList.forEach(item => {
    stats[item.title] = {
      views: item.views || 0,
      likes: item.likes || 0,
      lastViewed: new Date().toISOString()
    };
  });
  localStorage.setItem('foc_stats', JSON.stringify(stats));
}

function showPDF(index) {
  if (index < 0 || index >= pdfList.length) return;
  currentIndex = index;
  currentPage = 1;
  hasLikedCurrentPDF = false;

  const selectedItem = pdfList[index];
  const fileURL = selectedItem.url;
  
  console.log('å˜—è©¦è¼‰å…¥PDF:', fileURL);
  document.getElementById('statusText').innerHTML = 
    '<span class="loading"></span>è¼‰å…¥æ•™æä¸­â€¦';

  pdfjsLib.getDocument(fileURL).promise.then(pdf => {
    currentPDF = pdf;
    totalPages = pdf.numPages;
    renderPage(currentPage);
    
    document.getElementById('statusText').textContent =
      `ğŸŒŸ ç•¶å‰æ•™æï¼š${selectedItem.title} (${index + 1}/${pdfList.length})`;
  }).catch(err => {
    console.error('PDF è¼‰å…¥å¤±æ•—ï¼š', err.message);
    document.getElementById('statusText').innerHTML = 
      `âŒ ç„¡æ³•é¡¯ç¤ºæ•™æï¼š${err.message}<br>
      <small>å˜—è©¦è·¯å¾‘: ${fileURL}</small>`;
  });

  document.getElementById('pdfSelect').value = index;
}

// æ¸²æŸ“å’Œé¡µé¢æ§åˆ¶å‡½æ•°ï¼ˆä¸å‰é¢ç›¸åŒï¼‰
function renderPage(pageNum) {
  if (!currentPDF) return;
  
  currentPDF.getPage(pageNum).then(page => {
    const viewport = page.getViewport({ scale: currentScale });
    const canvas = document.getElementById('pdfCanvas');
    const context = canvas.getContext('2d');
    
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const renderContext = { canvasContext: context, viewport: viewport };
    
    page.render(renderContext).promise.then(() => {
      document.getElementById('pageInfo').textContent = 
        `ç¬¬ ${pageNum} é  / å…± ${totalPages} é `;
      document.getElementById('zoomLevel').textContent = 
        Math.round(currentScale * 100) + '%';
    });
  }).catch(err => {
    console.error('é é¢æ¸²æŸ“å¤±æ•—ï¼š', err);
    document.getElementById('statusText').textContent = 'âŒ é é¢æ¸²æŸ“å¤±æ•—';
  });
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', loadPDFList);